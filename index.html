<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Learning Notebook</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
    }

    #app { width: 100vw; height: 100vh; position: relative; background: #000; }

    /* Grid */
    #grid {
      position: absolute; inset: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.06) 1px, transparent 1px);
      background-size: 32px 32px;
      pointer-events: none;
      opacity: 0.25;
    }

    /* Canvas */
    #canvas { position: absolute; top: 0; left: 0; cursor: crosshair; touch-action: none; }

    /* FAB */
    #fab {
      position: fixed; top: 20px; left: 20px;
      width: 60px; height: 60px;
      background: #374151;
      border: 2px solid rgba(255,255,255,0.12);
      border-radius: 50%;
      color: white; font-size: 26px;
      display:flex; align-items:center; justify-content:center;
      z-index: 1100; cursor: pointer;
      transition: transform .18s ease, background .18s ease;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    }
    #fab:hover { transform: scale(1.07); background:#4B5563; }
    #fab.open { transform: rotate(45deg); }

    /* Menu container (buttons are positioned via JS around the fab) */
    .menu {
      position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1090;
    }

    .menu-btn {
      position: absolute;
      width: 50px; height: 50px;
      background: #374151;
      border: 2px solid rgba(255,255,255,0.12);
      border-radius: 50%;
      color: white;
      display:flex; align-items:center; justify-content:center;
      font-size: 18px;
      transition: transform .28s cubic-bezier(.2,.9,.18,1), opacity .18s ease;
      opacity: 0; pointer-events: auto;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    }
    .menu-btn:hover { transform: scale(1.12); background:#4B5563; }

    .menu-btn.save { background: #059669; border-color: rgba(16,185,129,0.5); }

    /* Settings Panel (top center) */
    #settings {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.88); backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.06); border-radius: 14px;
      padding: 14px; min-width: 320px; z-index: 1080; display: none;
    }
    #settings.show { display: block; }
    .settings-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .close-btn { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); color: white; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:12px; }

    .setting { margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .setting label{ font-size:13px; color:#e6eefc; }
    .setting input[type="color"] { width:40px; height:30px; border-radius:6px; border:none; padding:0; }
    .setting input[type="range"] { width:140px; }

    /* Text box + toolbar */
    .text-box { position:absolute; background: rgba(255,255,255,0.03); border:2px solid rgba(255,255,255,0.06); border-radius:12px; padding:8px; cursor:grab; transition: box-shadow .14s ease, border-color .14s ease; overflow:hidden; display:flex; flex-direction:column; gap:6px; }
    .text-box:active { cursor:grabbing; }
    .text-box.selected { border-color:#3B82F6; box-shadow: 0 4px 22px rgba(59,130,246,0.12); }

    .text-toolbar { display:flex; gap:6px; align-items:center; justify-content:flex-start; flex-wrap:wrap; }
    .text-toolbar input[type="number"]{ width:56px; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:#fff; }
    .text-toolbar input[type="color"]{ width:36px; height:28px; border-radius:6px; border:none; padding:0; }
    .text-toolbar select{ padding:6px; border-radius:6px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.06); color:#fff; }
    .text-toolbar button{ padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); color:#fff; cursor:pointer; font-size:13px; }
    .text-toolbar button.active{ background:#3B82F6; border-color:rgba(59,130,246,0.6); }

    .text-box textarea {
      width:100%; height:100%; background:transparent; border:none; color: #fff; resize:none; outline:none; font-family:inherit; padding:6px; flex:1; min-height:36px;
    }

    /* Link box */
    .link-box { position:absolute; background: rgba(255,255,255,0.03); border:2px dashed rgba(255,255,255,0.06); border-radius:10px; padding:8px; cursor:grab; display:flex; align-items:center; gap:8px; color:#60A5FA; }
    .link-box.selected { border-color:#3B82F6; box-shadow: 0 4px 22px rgba(59,130,246,0.08); }

    /* Image box */
    .image-box { position:absolute; border-radius:10px; overflow:hidden; cursor:grab; background:#111; border:2px solid rgba(255,255,255,0.02); }
    .image-box img{ width:100%; height:100%; object-fit:cover; display:block; }

    /* Helper */
    .helper { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); padding: 10px 14px; border-radius:10px; font-size:14px; color: rgba(255,255,255,0.78); z-index:1060; }
  </style>
</head>
<body>
  <div id="app">
    <div id="grid"></div>
    <canvas id="canvas"></canvas>
    <div id="content"></div>

    <button id="fab">+</button>

    <div class="menu" id="menu">
      <!-- Buttons will be positioned by JS relative to the FAB. keep order -->
      <button class="menu-btn" id="btn-draw" title="Draw">‚úèÔ∏è</button>
      <button class="menu-btn" id="btn-text" title="Text">üìù</button>
      <button class="menu-btn" id="btn-link" title="Link">üîó</button>
      <button class="menu-btn" id="btn-image" title="Image">üñºÔ∏è</button>
      <button class="menu-btn" id="btn-erase" title="Erase">üßΩ</button>
      <button class="menu-btn save" id="btn-save" title="Save">üíæ</button>
    </div>

    <div id="settings">
      <div class="settings-header">
        <h3 id="settings-title">Settings</h3>
        <button class="close-btn" onclick="closeSettings()">Close</button>
      </div>
      <div id="settings-content"></div>
    </div>

    <input type="file" id="file-input" accept="image/*" style="display:none;">
    <div class="helper">Click the + button for tools</div>
  </div>

  <script>
  /***** script: radial menu + canvas + text-box toolbar *****/

  // app state
  let mode = 'none';
  let menuOpen = false;
  let boxes = [];
  let strokes = [];
  let drawing = false;
  let currentStroke = null;
  let brushSize = 3;
  let brushColor = '#ffffff';

  // elements
  const fab = document.getElementById('fab');
  const menu = document.getElementById('menu');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const content = document.getElementById('content');
  const settings = document.getElementById('settings');
  const fileInput = document.getElementById('file-input');

  // init
  function init() {
    setupCanvas();
    setupEvents();
    window.addEventListener('resize', setupCanvas);
    console.log('App initialized');
  }

  // high-dpi canvas
  function setupCanvas() {
    const dpr = window.devicePixelRatio || 1;
    const w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    const h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    redrawCanvas();
  }

  function redrawCanvas() {
    ctx.clearRect(0,0,canvas.width, canvas.height);

    // strokes
    for (const stroke of strokes) {
      if (!stroke.points || stroke.points.length < 2) continue;
      ctx.beginPath();
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.strokeStyle = stroke.color || '#fff';
      ctx.lineWidth = stroke.size || 3;
      ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
      for (let i = 1; i < stroke.points.length; i++) ctx.lineTo(stroke.points[i].x, stroke.points[i].y);
      ctx.stroke();
    }

    // current
    if (currentStroke && currentStroke.points && currentStroke.points.length > 0) {
      ctx.beginPath();
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.strokeStyle = currentStroke.color || '#fff';
      ctx.lineWidth = currentStroke.size || 3;
      ctx.moveTo(currentStroke.points[0].x, currentStroke.points[0].y);
      for (let i = 1; i < currentStroke.points.length; i++) ctx.lineTo(currentStroke.points[i].x, currentStroke.points[i].y);
      ctx.stroke();
    }
  }

  // events
  function setupEvents() {
    fab.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(); });

    // menu buttons
    document.getElementById('btn-draw').addEventListener('click', () => setMode('draw'));
    document.getElementById('btn-text').addEventListener('click', () => setMode('text'));
    document.getElementById('btn-link').addEventListener('click', () => setMode('link'));
    document.getElementById('btn-image').addEventListener('click', () => { fileInput.click(); closeMenu(); });
    document.getElementById('btn-erase').addEventListener('click', () => setMode('erase'));
    document.getElementById('btn-save').addEventListener('click', () => { saveToGitHub(); closeMenu(); });

    // pointer events on canvas (supports touch & pen)
    canvas.addEventListener('pointerdown', onPointerDown);
    canvas.addEventListener('pointermove', onPointerMove);
    canvas.addEventListener('pointerup', onPointerUp);
    canvas.addEventListener('pointercancel', onPointerUp);

    // clicks to add text/link
    canvas.addEventListener('click', (e) => {
      if (drawing) return;
      const pos = getPos(e);
      if (mode === 'text') addTextBox(pos);
      if (mode === 'link') addLinkBox(pos);
    });

    fileInput.addEventListener('change', (e) => handleFileInput(e));
    document.addEventListener('click', (e) => { if (!e.target.closest('#fab') && !e.target.closest('.menu')) closeMenu(); });
  }

  // radial menu positioning around FAB
  function toggleMenu() {
    menuOpen = !menuOpen;
    fab.classList.toggle('open', menuOpen);
    fab.textContent = menuOpen ? '√ó' : '+';
    const buttons = Array.from(menu.querySelectorAll('.menu-btn'));
    const fabRect = fab.getBoundingClientRect();
    const centerX = fabRect.left + fabRect.width / 2;
    const centerY = fabRect.top + fabRect.height / 2;

    // place every button at the FAB center as starting point
    buttons.forEach(btn => {
      btn.style.left = (centerX - btn.offsetWidth / 2) + 'px';
      btn.style.top = (centerY - btn.offsetHeight / 2) + 'px';
      btn.style.opacity = menuOpen ? '1' : '0';
    });

    if (menuOpen) {
      menu.style.pointerEvents = 'auto';
      const radius = 100; // px radius
      const angleStep = (2 * Math.PI) / buttons.length;
      // start angle making first button go upward (-90deg)
      buttons.forEach((btn, i) => {
        const angle = -Math.PI / 2 + i * angleStep;
        const x = Math.round(Math.cos(angle) * radius);
        const y = Math.round(Math.sin(angle) * radius);
        // use transform so we can animate nicely
        btn.style.transform = `translate(${x}px, ${y}px)`;
      });
    } else {
      menu.style.pointerEvents = 'none';
      buttons.forEach(btn => {
        btn.style.transform = 'translate(0,0)';
      });
    }
  }

  function closeMenu() {
    menuOpen = false;
    fab.classList.remove('open');
    fab.textContent = '+';
    const buttons = Array.from(menu.querySelectorAll('.menu-btn'));
    menu.style.pointerEvents = 'none';
    buttons.forEach(btn => { btn.style.transform = 'translate(0,0)'; btn.style.opacity = '0'; });
  }

  function setMode(m) {
    mode = m;
    closeMenu();
    showSettings(mode);
    console.log('Mode set to', m);
  }

  function showSettings(currentMode) {
    const title = document.getElementById('settings-title');
    const contentEl = document.getElementById('settings-content');
    let html = '';
    if (currentMode === 'draw') {
      title.textContent = 'üé® Drawing';
      html = `
        <div class="setting">
          <label>Color</label>
          <input type="color" value="${brushColor}" onchange="(function(e){ brushColor = e.target.value; }) (event)">
        </div>
        <div class="setting">
          <label>Size: <span id="brush-size-label">${brushSize}px</span></label>
          <input type="range" min="1" max="50" value="${brushSize}" oninput="(function(e){ brushSize = parseInt(e.target.value); document.getElementById('brush-size-label').textContent = e.target.value + 'px'; })(event)">
        </div>
        <div style="margin-top:8px;">
          <button onclick="clearCanvas()" style="background:#dc2626;border:none;color:white;padding:8px 12px;border-radius:8px;cursor:pointer;">Clear All</button>
        </div>
      `;
    } else if (currentMode === 'text') {
      title.textContent = 'üìù Text Mode';
      html = `<p style="opacity:.85;font-size:13px;">Click anywhere on the canvas to add a text box. Use the inline toolbar inside the box to change font, size, color, bold/italic and dimensions.</p>`;
    } else if (currentMode === 'link') {
      title.textContent = 'üîó Link Mode';
      html = `<p style="opacity:.85;font-size:13px;">Click anywhere on the canvas to add a link box. Double-click a link box to open the URL.</p>`;
    } else if (currentMode === 'erase') {
      title.textContent = 'üßΩ Eraser';
      html = `<p style="opacity:.85;font-size:13px;">Click and drag on drawings to erase nearby strokes.</p>`;
    } else {
      title.textContent = 'Settings';
      html = `<p style="opacity:.85;font-size:13px;">Choose a tool from the + menu.</p>`;
    }
    contentEl.innerHTML = html;
    settings.classList.add('show');
  }

  function closeSettings() { settings.classList.remove('show'); mode = 'none'; }

  // pointer handlers for canvas
  function onPointerDown(e) {
    if (e.button && e.button !== 0) return;
    const pos = getPos(e);
    if (mode === 'draw') {
      drawing = true;
      currentStroke = { points: [pos], color: brushColor, size: brushSize };
    } else if (mode === 'erase') {
      eraseAt(pos);
    }
  }
  function onPointerMove(e) {
    const pos = getPos(e);
    if (drawing && currentStroke) {
      currentStroke.points.push(pos);
      redrawCanvas();
    } else if (mode === 'erase' && (e.buttons === 1 || e.pressure > 0)) {
      eraseAt(pos);
    }
  }
  function onPointerUp(e) {
    if (drawing && currentStroke) {
      strokes.push(currentStroke);
      currentStroke = null;
      drawing = false;
      redrawCanvas();
    }
  }

  function getPos(e) {
    const r = canvas.getBoundingClientRect();
    return { x: Math.round(e.clientX - r.left), y: Math.round(e.clientY - r.top) };
  }

  // add text/link/image boxes
  function addTextBox(pos) {
    const id = 'text-' + Date.now();
    const box = {
      id, type: 'text',
      x: Math.round(pos.x / 32) * 32, y: Math.round(pos.y / 32) * 32,
      width: 260, height: 100,
      text: '', color: '#ffffff', fontSize: 16, fontFamily: 'sans-serif', fontWeight: '400', fontStyle: 'normal'
    };
    boxes.push(box);
    renderTextBox(box);
    closeSettings();
  }

  function addLinkBox(pos) {
    const url = prompt('Enter URL (include https://)');
    if (!url) return;
    const id = 'link-' + Date.now();
    const box = { id, type: 'link', x: Math.round(pos.x / 32) * 32, y: Math.round(pos.y / 32) * 32, width: 260, height: 48, url, text: url };
    boxes.push(box);
    renderLinkBox(box);
    closeSettings();
  }

  function handleFileInput(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const id = 'image-' + Date.now();
      const box = { id, type: 'image', x: 120, y: 120, width: 220, height: 150, src: ev.target.result };
      boxes.push(box);
      renderImageBox(box);
    };
    reader.readAsDataURL(file);
    e.target.value = '';
  }

  // rendering boxes

  function renderTextBox(box) {
    // container
    const div = document.createElement('div');
    div.className = 'text-box';
    div.id = box.id;
    div.style.left = box.x + 'px';
    div.style.top = box.y + 'px';
    div.style.width = box.width + 'px';
    div.style.height = box.height + 'px';

    // toolbar
    const toolbar = document.createElement('div');
    toolbar.className = 'text-toolbar';

    // font size
    const sizeInput = document.createElement('input');
    sizeInput.type = 'number';
    sizeInput.value = box.fontSize;
    sizeInput.min = 8; sizeInput.max = 96;
    sizeInput.title = 'Font size (px)';
    sizeInput.addEventListener('input', () => {
      box.fontSize = Math.max(8, parseInt(sizeInput.value) || 8);
      textarea.style.fontSize = box.fontSize + 'px';
    });

    // color
    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.value = box.color;
    colorInput.title = 'Text color';
    colorInput.addEventListener('input', () => { box.color = colorInput.value; textarea.style.color = box.color; });

    // font family
    const fontSelect = document.createElement('select');
    const families = [
      {v:'sans-serif', t:'Sans-serif'},
      {v:'serif', t:'Serif'},
      {v:'monospace', t:'Monospace'},
      {v:'"Segoe UI", system-ui', t:'Segoe UI'}
    ];
    families.forEach(f => { const opt = document.createElement('option'); opt.value = f.v; opt.textContent = f.t; fontSelect.appendChild(opt); });
    fontSelect.value = box.fontFamily || 'sans-serif';
    fontSelect.addEventListener('change', () => { box.fontFamily = fontSelect.value; textarea.style.fontFamily = box.fontFamily; });

    // bold / italic toggles
    const boldBtn = document.createElement('button');
    boldBtn.textContent = 'B';
    boldBtn.title = 'Bold';
    boldBtn.addEventListener('click', () => {
      box.fontWeight = box.fontWeight === '700' ? '400' : '700';
      textarea.style.fontWeight = box.fontWeight;
      boldBtn.classList.toggle('active', box.fontWeight === '700');
    });

    const italicBtn = document.createElement('button');
    italicBtn.textContent = 'I';
    italicBtn.title = 'Italic';
    italicBtn.addEventListener('click', () => {
      box.fontStyle = box.fontStyle === 'italic' ? 'normal' : 'italic';
      textarea.style.fontStyle = box.fontStyle;
      italicBtn.classList.toggle('active', box.fontStyle === 'italic');
    });

    // width/height inputs
    const widthInput = document.createElement('input');
    widthInput.type = 'number';
    widthInput.value = box.width;
    widthInput.style.width = '72px';
    widthInput.title = 'Width (px)';
    widthInput.addEventListener('input', () => {
      box.width = Math.max(80, parseInt(widthInput.value) || 80);
      div.style.width = box.width + 'px';
    });

    const heightInput = document.createElement('input');
    heightInput.type = 'number';
    heightInput.value = box.height;
    heightInput.style.width = '72px';
    heightInput.title = 'Height (px)';
    heightInput.addEventListener('input', () => {
      box.height = Math.max(30, parseInt(heightInput.value) || 30);
      div.style.height = box.height + 'px';
    });

    // toolbar composition
    toolbar.appendChild(sizeInput);
    toolbar.appendChild(colorInput);
    toolbar.appendChild(fontSelect);
    toolbar.appendChild(boldBtn);
    toolbar.appendChild(italicBtn);
    toolbar.appendChild(widthInput);
    toolbar.appendChild(heightInput);

    // textarea
    const textarea = document.createElement('textarea');
    textarea.placeholder = 'Type here...';
    textarea.value = box.text || '';
    textarea.style.color = box.color;
    textarea.style.fontSize = box.fontSize + 'px';
    textarea.style.fontFamily = box.fontFamily;
    textarea.style.fontWeight = box.fontWeight;
    textarea.style.fontStyle = box.fontStyle;

    textarea.addEventListener('input', (e) => { box.text = e.target.value; });

    // keep toolbar clicks from triggering drag
    toolbar.addEventListener('pointerdown', (ev) => { ev.stopPropagation(); });

    div.appendChild(toolbar);
    div.appendChild(textarea);
    content.appendChild(div);

    makeDraggable(div, box);
    // reflect active states
    boldBtn.classList.toggle('active', box.fontWeight === '700');
    italicBtn.classList.toggle('active', box.fontStyle === 'italic');

    setTimeout(() => textarea.focus(), 80);
  }

  function renderLinkBox(box) {
    const div = document.createElement('div');
    div.className = 'link-box';
    div.id = box.id;
    div.style.left = box.x + 'px';
    div.style.top = box.y + 'px';
    div.style.width = box.width + 'px';
    div.style.height = box.height + 'px';
    div.textContent = 'üîó ' + box.text;

    div.addEventListener('dblclick', () => {
      try { window.open(box.url, '_blank'); } catch(e){}
    });

    // prevent drag start when double-clicking link text
    div.addEventListener('pointerdown', (ev) => { ev.stopPropagation(); });

    content.appendChild(div);
    makeDraggable(div, box);
  }

  function renderImageBox(box) {
    const div = document.createElement('div');
    div.className = 'image-box';
    div.id = box.id;
    div.style.left = box.x + 'px';
    div.style.top = box.y + 'px';
    div.style.width = box.width + 'px';
    div.style.height = box.height + 'px';

    const img = document.createElement('img');
    img.src = box.src;
    img.alt = 'uploaded';
    div.appendChild(img);
    content.appendChild(div);
    makeDraggable(div, box);
  }

  // draggable with pointer events (ignores inputs & toolbar)
  function makeDraggable(element, box) {
    element.addEventListener('pointerdown', (ev) => {
      // ignore if interacting with a control or textarea
      if (ev.target.closest('.text-toolbar') || ev.target.tagName === 'TEXTAREA' || ev.target.tagName === 'INPUT' || ev.target.tagName === 'SELECT' || ev.button !== 0) return;
      ev.preventDefault();
      const pid = ev.pointerId;
      element.setPointerCapture && element.setPointerCapture(pid);

      const startX = ev.clientX;
      const startY = ev.clientY;
      const startLeft = box.x;
      const startTop = box.y;

      element.classList.add('selected');

      function onMove(e) {
        if (e.pointerId !== pid) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        box.x = startLeft + dx;
        box.y = startTop + dy;
        element.style.left = box.x + 'px';
        element.style.top = box.y + 'px';
      }
      function onUp(e) {
        if (e.pointerId !== pid) return;
        element.releasePointerCapture && element.releasePointerCapture(pid);
        document.removeEventListener('pointermove', onMove);
        document.removeEventListener('pointerup', onUp);
        document.removeEventListener('pointercancel', onUp);
        element.classList.remove('selected');
      }
      document.addEventListener('pointermove', onMove);
      document.addEventListener('pointerup', onUp);
      document.addEventListener('pointercancel', onUp);
    });
  }

  // eraser removes strokes near pointer
  function eraseAt(pos) {
    const R = Math.max(8, brushSize * 3);
    strokes = strokes.filter(stroke => {
      if (!stroke.points) return true;
      return !stroke.points.some(p => {
        const dx = p.x - pos.x;
        const dy = p.y - pos.y;
        return (dx*dx + dy*dy) <= (R*R);
      });
    });
    redrawCanvas();
  }

  function clearCanvas() { strokes = []; redrawCanvas(); }

  // Save (same as before)
  async function saveToGitHub() {
    const token = prompt('GitHub Personal Access Token:');
    if (!token) return;
    const repo = prompt('Repository (username/repo-name):');
    if (!repo) return;
    const filename = prompt('Filename:', 'notebook-' + new Date().toISOString().slice(0,10) + '.json');
    if (!filename) return;
    const data = { timestamp: new Date().toISOString(), strokes, boxes, canvas: canvas.toDataURL() };
    try {
      const resp = await fetch(`https://api.github.com/repos/${repo}/contents/${filename}`, {
        method: 'PUT',
        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: `Save notebook ${filename}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null,2)))) })
      });
      if (resp.ok) alert('‚úÖ Saved to GitHub!');
      else { const err = await resp.json(); console.error(err); alert('‚ùå Save error: ' + (err.message || resp.status)); }
    } catch (err) { console.error(err); alert('‚ùå ' + err.message); }
  }

  // start
  init();

  </script>
</body>
</html>
