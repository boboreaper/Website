<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Notebook</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
        }
        
        #app {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #000;
        }
        
        /* Grid */
        #grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 32px 32px;
            pointer-events: none;
        }
        
        /* Canvas */
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
        
        /* FAB Button */
        #fab {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: #374151;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        #fab:hover {
            background: #4B5563;
            transform: scale(1.1);
        }
        
        #fab.open {
            transform: rotate(45deg);
        }
        
        /* Menu */
        .menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 999;
            pointer-events: none;
        }
        
        .menu-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #374151;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            opacity: 0;
            transform: scale(0);
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        
        .menu-btn:hover {
            background: #4B5563;
            transform: scale(1.1);
        }
        
        .menu.open .menu-btn {
            opacity: 1;
            transform: scale(1);
        }
        
        .menu-btn.save {
            background: #059669;
            border-color: rgba(16,185,129,0.5);
        }
        
        /* Settings Panel */
        #settings {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            min-width: 300px;
            z-index: 800;
            display: none;
        }
        
        #settings.show {
            display: block;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .setting {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .setting label {
            font-size: 14px;
        }
        
        .setting input[type="color"] {
            width: 40px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .setting input[type="range"] {
            width: 100px;
        }
        
        /* Text Box */
        .text-box {
            position: absolute;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px;
            cursor: move;
            transition: all 0.2s;
        }
        
        .text-box:hover,
        .text-box.selected {
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.3);
        }
        
        .text-box textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: white;
            resize: none;
            outline: none;
            font-family: inherit;
            font-size: 16px;
        }
        
        .text-box textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        /* Link Box */
        .link-box {
            position: absolute;
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 10px;
            cursor: move;
            transition: all 0.2s;
            color: #60A5FA;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        
        .link-box:hover,
        .link-box.selected {
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.3);
        }
        
        /* Image Box */
        .image-box {
            position: absolute;
            border: 2px solid transparent;
            border-radius: 10px;
            overflow: hidden;
            cursor: move;
            transition: all 0.2s;
        }
        
        .image-box:hover,
        .image-box.selected {
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.3);
        }
        
        .image-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Helper */
        .helper {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Grid Background -->
        <div id="grid"></div>
        
        <!-- Drawing Canvas -->
        <canvas id="canvas"></canvas>
        
        <!-- Content Container -->
        <div id="content"></div>
        
        <!-- FAB Button -->
        <button id="fab">+</button>
        
        <!-- Menu -->
        <div class="menu" id="menu">
            <button class="menu-btn" id="btn-draw" style="left: 85px; top: 30px;">‚úèÔ∏è</button>
            <button class="menu-btn" id="btn-text" style="left: 120px; top: 60px;">üìù</button>
            <button class="menu-btn" id="btn-link" style="left: 120px; top: 100px;">üîó</button>
            <button class="menu-btn" id="btn-image" style="left: 85px; top: 130px;">üñºÔ∏è</button>
            <button class="menu-btn" id="btn-erase" style="left: 30px; top: 130px;">üßΩ</button>
            <button class="menu-btn save" id="btn-save" style="left: 30px; top: 60px;">üíæ</button>
        </div>
        
        <!-- Settings Panel -->
        <div id="settings">
            <div class="settings-header">
                <h3 id="settings-title">Settings</h3>
                <button class="close-btn" onclick="closeSettings()">Close</button>
            </div>
            <div id="settings-content"></div>
        </div>
        
        <!-- File Input -->
        <input type="file" id="file-input" accept="image/*" style="display: none;">
        
        <!-- Helper -->
        <div class="helper">
            Click the + button for tools
        </div>
    </div>

    <script>
        // Global variables
        let mode = 'none';
        let menuOpen = false;
        let selectedBox = null;
        let boxes = [];
        let strokes = [];
        let drawing = false;
        let currentStroke = null;
        let brushSize = 3;
        let brushColor = '#ffffff';
        
        // Elements
        const fab = document.getElementById('fab');
        const menu = document.getElementById('menu');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const content = document.getElementById('content');
        const settings = document.getElementById('settings');
        const fileInput = document.getElementById('file-input');
        
        // Initialize
        function init() {
            setupCanvas();
            setupEvents();
            console.log('App initialized');
        }
        
        function setupCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            redrawCanvas();
        }
        
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw strokes
            strokes.forEach(stroke => {
                if (stroke.points.length < 2) return;
                
                ctx.strokeStyle = stroke.color;
                ctx.lineWidth = stroke.size;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
                for (let i = 1; i < stroke.points.length; i++) {
                    ctx.lineTo(stroke.points[i].x, stroke.points[i].y);
                }
                ctx.stroke();
            });
            
            // Draw current stroke
            if (currentStroke && currentStroke.points.length > 1) {
                ctx.strokeStyle = currentStroke.color;
                ctx.lineWidth = currentStroke.size;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(currentStroke.points[0].x, currentStroke.points[0].y);
                for (let i = 1; i < currentStroke.points.length; i++) {
                    ctx.lineTo(currentStroke.points[i].x, currentStroke.points[i].y);
                }
                ctx.stroke();
            }
        }
        
        function setupEvents() {
            // FAB button
            fab.addEventListener('click', () => {
                toggleMenu();
            });
            
            // Menu buttons
            document.getElementById('btn-draw').addEventListener('click', () => setMode('draw'));
            document.getElementById('btn-text').addEventListener('click', () => setMode('text'));
            document.getElementById('btn-link').addEventListener('click', () => setMode('link'));
            document.getElementById('btn-image').addEventListener('click', () => {
                fileInput.click();
                closeMenu();
            });
            document.getElementById('btn-erase').addEventListener('click', () => setMode('erase'));
            document.getElementById('btn-save').addEventListener('click', () => {
                saveToGitHub();
                closeMenu();
            });
            
            // Canvas drawing
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            
            // Canvas clicks for text/link
            canvas.addEventListener('click', handleCanvasClick);
            
            // File input
            fileInput.addEventListener('change', handleFileInput);
            
            // Window resize
            window.addEventListener('resize', setupCanvas);
            
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#fab') && !e.target.closest('.menu')) {
                    closeMenu();
                }
            });
        }
        
        function toggleMenu() {
            menuOpen = !menuOpen;
            fab.classList.toggle('open', menuOpen);
            menu.classList.toggle('open', menuOpen);
            fab.textContent = menuOpen ? '√ó' : '+';
            console.log('Menu toggled:', menuOpen);
        }
        
        function closeMenu() {
            menuOpen = false;
            fab.classList.remove('open');
            menu.classList.remove('open');
            fab.textContent = '+';
        }
        
        function setMode(newMode) {
            mode = newMode;
            closeMenu();
            showSettings(mode);
            console.log('Mode set to:', mode);
        }
        
        function showSettings(currentMode) {
            const title = document.getElementById('settings-title');
            const content = document.getElementById('settings-content');
            
            let html = '';
            
            if (currentMode === 'draw') {
                title.textContent = 'üé® Drawing';
                html = `
                    <div class="setting">
                        <label>Color:</label>
                        <input type="color" value="${brushColor}" onchange="brushColor = this.value">
                    </div>
                    <div class="setting">
                        <label>Size: ${brushSize}px</label>
                        <input type="range" min="1" max="50" value="${brushSize}" 
                               oninput="brushSize = parseInt(this.value); this.previousElementSibling.textContent = 'Size: ' + this.value + 'px'">
                    </div>
                    <button onclick="clearCanvas()" style="background: #dc2626; border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                        Clear All
                    </button>
                `;
            } else if (currentMode === 'text') {
                title.textContent = 'üìù Text Mode';
                html = `<p style="opacity: 0.8; font-size: 14px;">Click anywhere on the canvas to add a text box.</p>`;
            } else if (currentMode === 'link') {
                title.textContent = 'üîó Link Mode';
                html = `<p style="opacity: 0.8; font-size: 14px;">Click anywhere to add a link. You'll be prompted for the URL.</p>`;
            } else if (currentMode === 'erase') {
                title.textContent = 'üßΩ Eraser';
                html = `<p style="opacity: 0.8; font-size: 14px;">Click and drag on drawings to erase them.</p>`;
            }
            
            content.innerHTML = html;
            settings.classList.add('show');
        }
        
        function closeSettings() {
            settings.classList.remove('show');
            mode = 'none';
        }
        
        function handleMouseDown(e) {
            const pos = getMousePos(e);
            
            if (mode === 'draw') {
                drawing = true;
                currentStroke = {
                    points: [pos],
                    color: brushColor,
                    size: brushSize
                };
            } else if (mode === 'erase') {
                eraseAt(pos);
            }
        }
        
        function handleMouseMove(e) {
            if (!drawing || mode !== 'draw') return;
            
            const pos = getMousePos(e);
            currentStroke.points.push(pos);
            redrawCanvas();
        }
        
        function handleMouseUp() {
            if (drawing && currentStroke) {
                strokes.push(currentStroke);
                currentStroke = null;
                drawing = false;
                redrawCanvas();
            }
        }
        
        function handleCanvasClick(e) {
            if (drawing) return;
            
            const pos = getMousePos(e);
            
            if (mode === 'text') {
                addTextBox(pos);
            } else if (mode === 'link') {
                addLinkBox(pos);
            }
        }
        
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }
        
        function addTextBox(pos) {
            const id = 'text-' + Date.now();
            const box = {
                id,
                type: 'text',
                x: Math.round(pos.x / 32) * 32,
                y: Math.round(pos.y / 32) * 32,
                width: 200,
                height: 80,
                text: '',
                color: '#ffffff',
                fontSize: 16
            };
            
            boxes.push(box);
            renderTextBox(box);
            closeSettings();
            console.log('Added text box:', box);
        }
        
        function renderTextBox(box) {
            const div = document.createElement('div');
            div.className = 'text-box';
            div.id = box.id;
            div.style.left = box.x + 'px';
            div.style.top = box.y + 'px';
            div.style.width = box.width + 'px';
            div.style.height = box.height + 'px';
            
            const textarea = document.createElement('textarea');
            textarea.placeholder = 'Type here...';
            textarea.value = box.text;
            textarea.style.color = box.color;
            textarea.style.fontSize = box.fontSize + 'px';
            
            textarea.addEventListener('input', (e) => {
                box.text = e.target.value;
            });
            
            div.appendChild(textarea);
            content.appendChild(div);
            
            // Make draggable
            makeDraggable(div, box);
            
            // Focus the textarea
            setTimeout(() => textarea.focus(), 100);
        }
        
        function addLinkBox(pos) {
            const url = prompt('Enter URL:');
            if (!url) return;
            
            const id = 'link-' + Date.now();
            const box = {
                id,
                type: 'link',
                x: Math.round(pos.x / 32) * 32,
                y: Math.round(pos.y / 32) * 32,
                width: 200,
                height: 40,
                url,
                text: url
            };
            
            boxes.push(box);
            renderLinkBox(box);
            closeSettings();
            console.log('Added link box:', box);
        }
        
        function renderLinkBox(box) {
            const div = document.createElement('div');
            div.className = 'link-box';
            div.id = box.id;
            div.style.left = box.x + 'px';
            div.style.top = box.y + 'px';
            div.style.width = box.width + 'px';
            div.style.height = box.height + 'px';
            div.textContent = 'üîó ' + box.text;
            
            div.addEventListener('dblclick', () => {
                window.open(box.url, '_blank');
            });
            
            content.appendChild(div);
            makeDraggable(div, box);
        }
        
        function handleFileInput(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const id = 'image-' + Date.now();
                const box = {
                    id,
                    type: 'image',
                    x: 100,
                    y: 100,
                    width: 200,
                    height: 150,
                    src: event.target.result
                };
                
                boxes.push(box);
                renderImageBox(box);
                console.log('Added image box:', box);
            };
            reader.readAsDataURL(file);
        }
        
        function renderImageBox(box) {
            const div = document.createElement('div');
            div.className = 'image-box';
            div.id = box.id;
            div.style.left = box.x + 'px';
            div.style.top = box.y + 'px';
            div.style.width = box.width + 'px';
            div.style.height = box.height + 'px';
            
            const img = document.createElement('img');
            img.src = box.src;
            img.alt = 'Uploaded image';
            
            div.appendChild(img);
            content.appendChild(div);
            makeDraggable(div, box);
        }
        
        function makeDraggable(element, box) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            
            element.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'TEXTAREA') return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = box.x;
                startTop = box.y;
                
                // Select this box
                document.querySelectorAll('.text-box, .link-box, .image-box').forEach(el => {
                    el.classList.remove('selected');
                });
                element.classList.add('selected');
                selectedBox = box.id;
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                box.x = startLeft + dx;
                box.y = startTop + dy;
                
                element.style.left = box.x + 'px';
                element.style.top = box.y + 'px';
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }
        
        function eraseAt(pos) {
            const radius = brushSize * 3;
            strokes = strokes.filter(stroke => {
                return !stroke.points.some(point => {
                    const dx = point.x - pos.x;
                    const dy = point.y - pos.y;
                    return Math.sqrt(dx * dx + dy * dy) < radius;
                });
            });
            redrawCanvas();
        }
        
        function clearCanvas() {
            strokes = [];
            redrawCanvas();
        }
        
        async function saveToGitHub() {
            const token = prompt('GitHub Personal Access Token:');
            if (!token) return;
            
            const repo = prompt('Repository (username/repo-name):');
            if (!repo) return;
            
            const filename = prompt('Filename:', 'notebook-' + new Date().toISOString().slice(0,10) + '.json');
            if (!filename) return;
            
            const data = {
                timestamp: new Date().toISOString(),
                strokes: strokes,
                boxes: boxes,
                canvas: canvas.toDataURL()
            };
            
            try {
                const response = await fetch(`https://api.github.com/repos/${repo}/contents/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Save notebook: ${filename}`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))))
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Successfully saved to GitHub!');
                } else {
                    alert('‚ùå Error saving to GitHub');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Start the app
        init();
    </script>
</body>
</html>
